<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lakbay | Commuter Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; }
    header { background: #f0f0f0; padding: 10px 20px; }
    nav { display: flex; justify-content: space-between; align-items: center; }
    nav ul { list-style: none; display: flex; gap: 15px; padding: 0; margin: 0; }
    nav a { text-decoration: none; color: #000; }
    main { flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    .map-section { text-align: center; width: 80%; max-width: 900px; }
    #map { width: 100%; height: 500px; border: 2px solid #000; margin-top: 20px; border-radius: 8px; }
    #location-status { margin-top: 10px; font-size: 0.9em; color: gray; }
    .controls { margin-top: 10px; }
    .controls button { margin-right: 8px; padding: 8px 18px; border-radius: 5px; border: none; font-size: 1em; }
    #highlight-btn { background-color: #007bff; color: white; }
    #clear-btn { background-color: #dc3545; color: white; }
    #show-btn { background-color: #28a745; color: white; }
    #track-btn { background-color: #007bff; color: white; padding: 12px 24px; margin: 12px 0;}
    #routes-list button { margin-left:12px; background:#dc3545; color:white; border:none; border-radius:4px; padding:3px 9px; cursor:pointer;}
    #routes-list { margin-bottom:10px; }
    .route-info { margin-bottom:4px; }
    footer { background: #f0f0f0; text-align: center; padding: 10px 0; }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo"><h2>Lakbay</h2></div>
      <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="#">Routes</a></li>
        <li><a href="#">Saved Trips</a></li>
        <li><a href="#">Help</a></li>
        <li><a href="index.html">Logout</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <section class="map-section">
      <h1>Commuter Dashboard</h1>
      <div id="map"></div>
      <div id="location-status">Waiting to start...</div>
      <button id="track-btn">Start Tracking My Location Now</button>
      <div class="controls">
        <button id="show-btn">Show All Routes</button>
        <button id="highlight-btn">Highlight Nearest Route</button>
        <button id="clear-btn">Clear Destination</button>
      </div>
      <div id="routes-list"></div>
    </section>
  </main>
  <footer>
    <p>© 2025 Lakbay. All rights reserved.</p>
  </footer>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    const map = L.map('map').setView([14.7959, 120.8789], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let routeLines = [];
    let jeepneyMarker = null;
    let userMarker = null;

    // Draw all saved driver routes as RoutingMachine using waypoints (not snapped route!)
    function drawSavedRoutes() {
      clearRoutes();
      fetch('/api/routes')
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          if (Array.isArray(data)) {
            data.forEach((driverRoute, idx) => {
              if (driverRoute.waypoints && driverRoute.waypoints.length > 1) {
                const waypoints = driverRoute.waypoints.map(p => L.latLng(p.lat, p.lng));
                const routeControl = L.Routing.control({
                  waypoints: waypoints,
                  lineOptions: { styles: [{ color: 'orange', weight: 6 }] },
                  router: L.Routing.osrmv1({ profile: 'driving' }),
                  addWaypoints: false,
                  routeWhileDragging: false,
                  showAlternatives: false,
                  createMarker: function() { return null; }
                }).addTo(map);
                routeLines.push(routeControl);
              }
            });
          }
        })
        .catch(err => { });
    }

    document.getElementById("show-btn").onclick = () => {
      drawSavedRoutes();
      refreshRoutesList();
    };

    document.getElementById("highlight-btn").onclick = () => {
      if (!userMarker) {
        alert("Please start tracking your location first.");
        return;
      }
      const userLatLng = userMarker.getLatLng();
      let nearestRouteIdx = -1;
      let minDist = Infinity;
      fetch('/api/routes')
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          if (Array.isArray(data)) {
            data.forEach((driverRoute, idx) => {
              if (driverRoute.waypoints && driverRoute.waypoints.length > 1) {
                driverRoute.waypoints.forEach(pt => {
                  const dist = map.distance(userLatLng, L.latLng(pt.lat, pt.lng));
                  if (dist < minDist) {
                    minDist = dist;
                    nearestRouteIdx = idx;
                  }
                });
              }
            });
          }
          clearRoutes();
          // Draw only nearest route
          if (nearestRouteIdx !== -1 && data[nearestRouteIdx].waypoints) {
            const waypoints = data[nearestRouteIdx].waypoints.map(p => L.latLng(p.lat, p.lng));
            const highlightControl = L.Routing.control({
              waypoints: waypoints,
              lineOptions: { styles: [{ color: 'orange', weight: 8 }] },
              router: L.Routing.osrmv1({ profile: 'driving' }),
              addWaypoints: false,
              routeWhileDragging: false,
              showAlternatives: false,
              createMarker: function() { return null; }
            }).addTo(map);
            routeLines.push(highlightControl);
          }
        })
        .catch(err => { });
    };

    document.getElementById("clear-btn").onclick = () => {
      routeLines.forEach(line => {
        if (line && typeof line.remove === "function") {
          line.remove();
        } else if (line && typeof map.removeControl === "function") {
          map.removeControl(line);
        } else if (line && typeof map.removeLayer === "function") {
          map.removeLayer(line);
        }
      });
      routeLines = [];
      refreshRoutesList();
    };

    function clearRoutes() {
      routeLines.forEach(line => {
        if (line && typeof line.remove === "function") {
          line.remove();
        } else if (line && typeof map.removeControl === "function") {
          map.removeControl(line);
        } else if (line && typeof map.removeLayer === "function") {
          map.removeLayer(line);
        }
      });
      routeLines = [];
    }

    document.getElementById("track-btn").onclick = () => {
      if (userMarker) map.removeLayer(userMarker);
      map.locate({ watch: true, setView: true, maxZoom: 15 });
    };

    map.on('locationfound', function(e) {
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker(e.latlng, { draggable: false }).addTo(map)
        .bindPopup("You are here!").openPopup();
      document.getElementById("location-status").textContent =
        `Location detected (±${Math.round(e.accuracy)}m)`;
    });

    map.on('locationerror', function(e) {
      document.getElementById("location-status").textContent = "Unable to detect location: " + e.message;
    });

    function pollJeepney() {
      fetch('/api/jeepney-location')
        .then(res => {
          if (!res.ok) throw new Error("Network response was not ok");
          return res.json();
        })
        .then(data => {
          if (data.location) {
            const latLng = [data.location.lat, data.location.lng];
            if (!jeepneyMarker) {
              jeepneyMarker = L.marker(latLng, {
                icon: L.icon({
                  iconUrl: 'icons/Jeep.png',
                  iconSize: [32,32],
                  iconAnchor: [16,16]
                })
              }).addTo(map).bindPopup("Jeepney Location");
            } else {
              jeepneyMarker.setLatLng(latLng);
            }
          } else if (jeepneyMarker) {
            map.removeLayer(jeepneyMarker);
            jeepneyMarker = null;
          }
        })
        .catch(err => { });
    }
    setInterval(pollJeepney, 1000);

    function refreshRoutesList() {
      fetch('/api/routes')
        .then(res => res.json())
        .then(routes => {
          const routesListDiv = document.getElementById("routes-list");
          routesListDiv.innerHTML = '';
          routes.forEach((routeObj, idx) => {
            const div = document.createElement('div');
            div.className = "route-info";
            div.textContent = `Saved Route #${idx+1} (${routeObj.route.length} points)`;
            const delBtn = document.createElement('button');
            delBtn.textContent = "Delete";
            delBtn.onclick = () => {
              fetch(`/api/routes/${idx}`, { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                  alert(data.message || "Route deleted!");
                  refreshRoutesList();
                  document.getElementById("show-btn").click();
                });
            };
            div.appendChild(delBtn);
            routesListDiv.appendChild(div);
          });
        });
    }
    // Initial load
    drawSavedRoutes();
    refreshRoutesList();
  </script>
</body>
</html>